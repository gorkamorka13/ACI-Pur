<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paramètres - MSP Gestion</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="stylesheet" href="../css/style.css">
    <!-- Ajout de Font Awesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <!-- Authentication -->
        <script type="module" src="../js/auth.js"></script>
    <style>
        .content-section {
            background: white;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .alert-info {
            background-color: #f8f9fa;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .alert-info i {
            color: #2196F3;
            font-size: 1.2em;
            margin-top: 2px;
        }

        .alert-info p {
            margin: 0;
            color: #666;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 8px 16px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            color: #666;
            transition: all 0.2s;
        }

        .tab.active {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
        }

        .tab:hover:not(.active) {
            background: #f5f5f5;
        }

        .section-title {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 8px;
        }

        .section-subtitle {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .repartition-bar {
            height: 24px;
            background: #f5f5f5;
            border-radius: 12px;
            display: flex;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .repartition-segment {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.85em;
            white-space: nowrap;
            padding: 0 10px;
        }

        .repartition-segment.part-fixe {
            background: #2196F3;
        }

        .repartition-segment.part-rcp {
            background: #64B5F6;
        }

        .repartition-segment.part-projets {
            background: #4CAF50;
        }

        .slider-group {
            margin-bottom: 25px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 8px;
        }

        .slider-label {
            color: #333;
            font-size: 0.9em;
        }

        .slider-value {
            color: #2196F3;
            font-weight: 500;
            font-size: 0.9em;
        }

        .slider-description {
            color: #666;
            font-size: 0.85em;
            margin-bottom: 12px;
        }

        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #2196F3;
            cursor: pointer;
            transition: all 0.2s;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .slider-range {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #999;
            margin-top: 8px;
        }

        .btn-save {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            float: right;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-save:hover {
            background: #1976D2;
        }

        .btn-save i {
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo" style="background-color: #2c3e50;">
                <img src="/assets/favicon.ico" alt="Logo MSP" style="height: 20px; margin-right: 10px;"><h1>MSP Gestion</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html"><i class="fas fa-home"></i> Accueil</a></li>
                    <li><a href="revenus.html"><i class="fas fa-money-bill-wave"></i> Revenus ACI</a></li>
                    <li><a href="associes.html"><i class="fas fa-user-md"></i> Associés</a></li>
                    <li><a href="charges.html"><i class="fas fa-file-invoice-dollar"></i> Charges</a></li>
                    <li><a href="rcpmeeting.html"><i class="fas fa-users"></i> Réunions RCP</a></li>
                    <li><a href="projets.html"><i class="fas fa-tasks"></i> Projets & Missions</a></li>
                    <li><a href="repartition.html"><i class="fas fa-chart-pie"></i> Répartition</a></li>
                    <li class="active"><a href="parametres.html"><i class="fas fa-cog"></i> Paramètres</a></li>
<li><a href="../login.html" id="logoutButton"><i class="fas fa-sign-out-alt"></i> Déconnexion</a></li>
                </ul>
            </nav>
        </div>
        <div class="main-content">
            <header>
                <div class="header-content">
                    <h1>Paramètres de Répartition</h1>
                    <div class="user-info">
                        <img id="userAvatar" src="/images/default_avatar.png" alt="User Avatar" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; vertical-align: middle;">
                        <span id="usernameDisplay">Utilisateur</span>
                        <!-- <i class="fas fa-user-circle"></i> --> <!-- Optional: Keep or remove -->
                    </div>
                </div>
            </header>

            <div class="alert-info">
                <i class="fas fa-info-circle"></i>
                <p>La modification des facteurs de pondération affectera directement la répartition des rémunérations entre les associés de la MSP.</p>
            </div>

            <div class="tabs">
                <button class="tab active">Facteurs de répartition</button>
                <button class="tab">Paramètres généraux</button>
                <button class="tab">Génération de rapports</button>
                <button class="tab">Gestion des utilisateurs</button>
            </div>

            <div class="content-section" id="facteurs-repartition-section">
                <h2 class="section-title">Facteurs de pondération</h2>
                <p class="section-subtitle">Définissez les facteurs qui impactent la répartition des rémunérations entre les associés.</p>

                <div class="repartition-bar">
                    <div class="repartition-segment part-fixe" style="width: 50%">Part fixe: 50%</div>
                    <div class="repartition-segment part-rcp" style="width: 25%">RCP: 25%</div>
                    <div class="repartition-segment part-projets" style="width: 25%">Projets: 25%</div>
                </div>

                <div class="slider-group">
                    <div class="slider-header">
                        <span class="slider-label">Facteur cogérant</span>
                        <span class="slider-value">×1.7</span>
                    </div>
                    <p class="slider-description">Pondération appliquée aux associés ayant le statut de gérant</p>
                    <input type="range" class="slider" id="slider-cogerant" min="0.5" max="3" step="0.1" value="1.7">
                    <div class="slider-range">
                        <span>×0.5</span>
                        <span>×3.0</span>
                                </div>
                            </div>

                <div class="slider-group">
                    <div class="slider-header">
                        <span class="slider-label">Pourcentage RCP</span>
                        <span class="slider-value">25%</span>
                    </div>
                    <p class="slider-description">Part des revenus nets attribuée en fonction de la présence aux RCP</p>
                    <input type="range" class="slider" id="slider-rcp" min="0" max="50" value="25">
                    <div class="slider-range">
                        <span>0%</span>
                        <span>50%</span>
                            </div>
                    </div>
                    
                <div class="slider-group">
                    <div class="slider-header">
                        <span class="slider-label">Pourcentage projets</span>
                        <span class="slider-value">25%</span>
                    </div>
                    <p class="slider-description">Part des revenus nets attribuée en fonction de l'implication dans les projets</p>
                    <input type="range" class="slider" id="slider-projets" min="0" max="75" value="25">
                    <div class="slider-range">
                        <span>0%</span>
                        <span>75%</span>
                    </div>
                </div>

                <button class="btn-save">
                    <i class="fas fa-save"></i>
                    Enregistrer les modifications
                </button>
            </div>

            <!-- Section Paramètres généraux -->
            <div class="content-section" id="parametres-generaux-section" style="display: none;">
                <h2 class="section-title">Paramètres généraux</h2>
                <p class="section-subtitle">Configurez les paramètres généraux de l'application.</p>
                <!-- Add general settings content here -->
            </div>

            <!-- Section Génération de rapports -->
            <div class="content-section" id="sauvegarde-export-section" style="display: none;">
                <h2 class="section-title">Génération de rapports</h2>
                <p class="section-subtitle">Gérez la sauvegarde et l'exportation des données.</p>
                <!-- Embedded frame for report selection -->
                <div id="report-selection-frame" style="display: none; margin-top: 20px; border: 1px solid #e0e0e0; padding: 15px; border-radius: 4px;">
                    <p>Choisissez les rapports que vous souhaitez télécharger :</p>
                    <div>
                        <input type="checkbox" id="checkbox-charges-report">
                        <label for="checkbox-charges-report">Rapport de Charges</label>
                    </div>
                    <div>
                        <input type="checkbox" id="checkbox-revenus-report">
                        <label for="checkbox-revenus-report">Rapport de Revenus</label>
                    </div>
                    <!-- Add checkbox for Associates Report -->
                    <div>
                        <input type="checkbox" id="checkbox-associates-report">
                        <label for="checkbox-associates-report">Rapport des Associés</label>
                    </div>
                    <!-- Add checkbox for Projets Report -->
                    <div>
                        <input type="checkbox" id="checkbox-projets-report">
                        <label for="checkbox-projets-report">Rapport des Projets et Missions</label>
                    </div>
                    <!-- Add checkbox for RCP Meetings Report -->
                    <div>
                        <input type="checkbox" id="checkbox-rcp-meetings-report">
                        <label for="checkbox-rcp-meetings-report">Rapport Réunions RCP</label>
                    </div>
                    <button id="btn-download-reports" class="btn btn-primary" style="margin-top: 15px;">Télécharger</button>
                </div>
                <!-- New Export Data Button -->
                <button id="exportDataBtn" class="btn btn-primary" style="margin-top: 15px;">Exporter les données</button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation de réinitialisation -->
    <div class="modal" id="modal-confirm-reset">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Confirmer la réinitialisation</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="warning-message">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Cette action va supprimer définitivement toutes les données de l'application.</p>
                    <p>Cette opération ne peut pas être annulée.</p>
                    <p>Êtes-vous sûr de vouloir continuer ?</p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btn-confirm-reset" class="btn btn-danger">Oui, réinitialiser</button>
                <button class="btn btn-secondary modal-close">Annuler</button>
            </div>
        </div>
    </div>

    <script type="module" src="../js/main.js"></script> <!-- Load main JS first -->
    <script type="module">
        import { dataService } from '../js/services/DataService.js'; // Import DataService

        // Function to handle report download
        async function downloadReport(reportType) {
            try {
                const token = localStorage.getItem('token');
                // Determine endpoint based on report type
                let endpoint = '';
                if (reportType === 'associates') {
                    endpoint = '/api/associates/report'; // Call the backend endpoint for associates report
                } else if (reportType === 'charges') {
                    endpoint = '/api/charges/report/pdf';
                } else if (reportType === 'revenus') {
                    endpoint = '/api/revenus/report/pdf';
                } else if (reportType === 'projets') {
                    endpoint = '/api/projets/report/pdf'; // Set the correct endpoint for projets report
                } else if (reportType === 'rcp-meetings') { // Add case for RCP meetings report
                    endpoint = '/api/rcpMeetings/report/pdf';
                } else {
                    console.error(`Unknown report type: ${reportType}`);
                    return;
                }

                // Only proceed if endpoint is set
                if (!endpoint) {
                    console.error(`Endpoint not set for report type: ${reportType}`);
                    return;
                }

                const response = await fetch(endpoint, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${reportType}_report.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error(`Erreur lors du téléchargement du rapport ${reportType}:`, error);
                if (window.showAlert) {
                    window.showAlert(`Erreur lors du téléchargement du rapport ${reportType}: ` + error.message, 'danger');
                } else {
                    alert(`Erreur lors du téléchargement du rapport ${reportType}: ` + error.message);
                }
            }
        }

        // Paramètres (sera chargé depuis l'API ou utilisera les valeurs HTML par défaut)
        let parametres = null;
        // Éléments DOM
        const sliderCogerant = document.getElementById('slider-cogerant');
        const sliderRCP = document.getElementById('slider-rcp');
        const sliderProjets = document.getElementById('slider-projets');
        const barPartFixe = document.querySelector('.part-fixe');
        const barPartRCP = document.querySelector('.part-rcp');
        const barPartProjets = document.querySelector('.part-projets');
        
        // Fonction pour mettre à jour l'affichage
        function updateDisplay() {
            // Mettre à jour les valeurs affichées des sliders
            const valueCogerant = sliderCogerant.value;
            const valueRCP = sliderRCP.value;
            const valueProjets = sliderProjets.value;
            const partFixe = 100 - (parseInt(valueRCP) + parseInt(valueProjets));

            // Mettre à jour les textes des valeurs
            document.querySelectorAll('.slider-value')[0].textContent = '×' + valueCogerant;
            document.querySelectorAll('.slider-value')[1].textContent = valueRCP + '%';
            document.querySelectorAll('.slider-value')[2].textContent = valueProjets + '%';

            // Mettre à jour la barre de répartition
            barPartFixe.style.width = partFixe + '%';
            barPartFixe.textContent = 'Part fixe: ' + partFixe + '%';
            barPartRCP.style.width = valueRCP + '%';
            barPartRCP.textContent = 'RCP: ' + valueRCP + '%';
            barPartProjets.style.width = valueProjets + '%';
            barPartProjets.textContent = 'Projets: ' + valueProjets + '%';

            // Vérifier si le total est égal à 100%
            const total = partFixe + parseInt(valueRCP) + parseInt(valueProjets);
            const btnSave = document.querySelector('.btn-save');
            btnSave.disabled = total !== 100;
            btnSave.style.opacity = total !== 100 ? '0.5' : '1';

            // Mettre à jour les couleurs des valeurs
            const sliderValues = document.querySelectorAll('.slider-value');
            sliderValues.forEach(value => {
                value.style.color = total === 100 ? '#2196F3' : '#f44336';
            });

            return total === 100;
            }
            
        // Événements des sliders
        sliderCogerant.addEventListener('input', updateDisplay);

        [sliderRCP, sliderProjets].forEach(slider => {
            slider.addEventListener('input', function() {
                const currentRCP = parseInt(sliderRCP.value);
                const currentProjets = parseInt(sliderProjets.value);
                const total = currentRCP + currentProjets;

                // Ajuster automatiquement si le total dépasse 100%
                if (total > 100) {
                    if (this === sliderRCP) {
                        sliderProjets.value = Math.max(0, 100 - currentRCP);
            } else {
                        sliderRCP.value = Math.max(0, 100 - currentProjets);
                    }
                }

                updateDisplay();
            });
        });

        // Fonction séparée pour gérer l'input des sliders RCP/Projets
        function handleVariableSliderInput() {
            const currentRCP = parseInt(sliderRCP.value);
            const currentProjets = parseInt(sliderProjets.value);
            const total = currentRCP + currentProjets;

            // Ajuster automatiquement si le total dépasse 100%
            if (total > 100) {
                if (this === sliderRCP) {
                    sliderProjets.value = Math.max(0, 100 - currentRCP);
                } else {
                    sliderRCP.value = Math.max(0, 100 - currentProjets);
                }
            }
            updateDisplay(); // Mettre à jour l'affichage après ajustement potentiel
        }

        // Fonction séparée pour gérer le clic sur le bouton de sauvegarde
        async function handleSaveClick() {
            console.log("Save button clicked.");
            if (updateDisplay()) { // updateDisplay vérifie aussi si le total est 100%
                const partFixe = 100 - (parseInt(sliderRCP.value) + parseInt(sliderProjets.value));
                const newParams = {
                    // Assurer que l'ID n'est pas envoyé si ce n'est pas nécessaire par l'API PUT
                    // L'API actuelle semble ignorer l'ID dans le body et utilise celui de l'URL (implicitement 1)
                    partFixe: partFixe,
                    facteurCogerant: parseFloat(sliderCogerant.value),
                    partRCP: parseInt(sliderRCP.value),
                    partProjets: parseInt(sliderProjets.value)
                };
                console.log("Saving parameters:", newParams);

                try {
                    const savedParams = await dataService.saveParametresRepartition(newParams);
                    parametres = savedParams; // Mettre à jour les paramètres en mémoire localement
                    console.log("Parameters saved successfully:", savedParams);
                    
                    if (window.showAlert) {
                         window.showAlert('Paramètres enregistrés avec succès!', 'success');
                    } else {
                        alert('Paramètres enregistrés avec succès!');
                    }
                    updateDisplay(); // Mettre à jour l'affichage après sauvegarde

                } catch (error) {
                    console.error("Erreur lors de la sauvegarde des paramètres:", error);
                     if (window.showAlert) {
                         window.showAlert("Erreur sauvegarde: " + error.message, 'danger');
                     } else {
                        alert("Erreur sauvegarde: " + error.message);
                     }
                }
            } else {
                 console.log("Save prevented: Total is not 100%.");
            }
        }

        // Fonction d'initialisation
        async function initializePage() {
            console.log("Initializing parameters page...");
            // Charger les valeurs depuis l'API via DataService
            try {
                parametres = await dataService.loadParametresRepartition();
                if (parametres) {
                    console.log("Paramètres chargés depuis l'API:", parametres);
                    sliderCogerant.value = parametres.facteurCogerant;
                    sliderRCP.value = parametres.partRCP;
                    sliderProjets.value = parametres.partProjets;
                } else {
                    console.warn("Aucun paramètre initial chargé depuis l'API, utilisation des valeurs par défaut du HTML.");
                    // Lire les valeurs par défaut des sliders HTML pour initialiser l'objet parametres
                    parametres = {
                         partFixe: 100 - (parseInt(sliderRCP.value) + parseInt(sliderProjets.value)),
                         facteurCogerant: parseFloat(sliderCogerant.value),
                         partRCP: parseInt(sliderRCP.value),
                         partProjets: parseInt(sliderProjets.value)
                    };
                }
            } catch (error) {
                 console.error("Erreur lors du chargement des paramètres initiaux:", error);
                 alert("Erreur chargement paramètres: " + error.message + "\nUtilisation des valeurs par défaut.");
                 // Lire les valeurs par défaut des sliders HTML en cas d'erreur
                 parametres = {
                      partFixe: 100 - (parseInt(sliderRCP.value) + parseInt(sliderProjets.value)),
                      facteurCogerant: parseFloat(sliderCogerant.value),
                      partRCP: parseInt(sliderRCP.value),
                      partProjets: parseInt(sliderProjets.value)
                 };
            }

            // Load all data for export functionality
            try {
                globalData.revenus = await dataService.loadRevenus();
                console.log("Revenus loaded for export:", globalData.revenus);
            } catch (error) {
                console.error("Error loading Revenus for export:", error);
            }
            try {
                globalData.charges = await dataService.loadCharges();
                console.log("Charges loaded for export:", globalData.charges);
            } catch (error) {
                console.error("Error loading Charges for export:", error);
            }
             try {
                globalData.associes = await dataService.loadProfessionnels();
                console.log("Associés loaded for export:", globalData.associes);
            } catch (error) {
                console.error("Error loading Associés for export:", error);
            }
             try {
                globalData.rcpmeetings = await dataService.loadRcpMeetings();
                console.log("Réunions RCP loaded for export:", globalData.rcpmeetings);
            } catch (error) {
                console.error("Error loading Réunions RCP for export:", error);
            }
             try {
                globalData.projets = await dataService.loadProjets();
                console.log("Projets loaded for export:", globalData.projets);
            } catch (error) {
                console.error("Error loading Projets for export:", error);
            }
             try {
                // Assuming there's a service method to load rcpPresenceData if needed for export
                // globalData.rcpPresenceData = await dataService.loadRcpPresenceData();
                // console.log("RCP Presence Data loaded for export:", globalData.rcpPresenceData);
            } catch (error) {
                console.error("Error loading RCP Presence Data for export:", error);
            }


            // Mettre à jour l'affichage initial APRES avoir défini les valeurs des sliders
            console.log("Updating initial display...");
            updateDisplay();

            // Attacher les écouteurs d'événements ICI, après l'initialisation
            console.log("Attaching event listeners...");
            sliderCogerant.addEventListener('input', updateDisplay);
            sliderRCP.addEventListener('input', handleVariableSliderInput);
            sliderProjets.addEventListener('input', handleVariableSliderInput);
            document.querySelector('.btn-save').addEventListener('click', handleSaveClick); // Utiliser une fonction nommée
            // Get all tabs and content sections
            const tabs = document.querySelectorAll('.tab');
            const contentSections = document.querySelectorAll('.content-section');
            const reportSelectionFrame = document.getElementById('report-selection-frame'); // Get the new frame

            // Add click listeners to tabs
            tabs.forEach((tab, index) => {
                tab.addEventListener('click', function() {
                    console.log(`Tab clicked: ${this.textContent}`);
                    // Remove active class from all tabs and hide all content sections
                    tabs.forEach(t => t.classList.remove('active'));
                    contentSections.forEach(section => section.style.display = 'none');

                    // Add active class to the clicked tab
                    this.classList.add('active');

                    // Display the corresponding content section or the report frame
                    if (this.textContent.trim() === 'Génération de rapports') {
                        console.log("Génération de rapports tab clicked. Displaying report frame.");
                        if (reportSelectionFrame) {
                            reportSelectionFrame.style.display = 'block'; // Show the frame
                            // Also ensure the parent section is visible
                            const parentSection = document.getElementById('sauvegarde-export-section');
                            if (parentSection) parentSection.style.display = 'block';
                        } else {
                            console.error("Report selection frame element not found when clicking tab.");
                        }
                    } else {
                        // Hide the report frame if another tab is clicked
                        if (reportSelectionFrame) {
                            reportSelectionFrame.style.display = 'none';
                        }
                        // Show the corresponding content section based on index
                        if (contentSections[index]) {
                             contentSections[index].style.display = 'block';
                        } else {
                             console.error(`Content section not found for tab index ${index}`);
                        }
                    }
                });
            });

            // Add event listener for the download button in the new modal
            const btnDownloadReports = document.getElementById('btn-download-reports');
            const checkboxCharges = document.getElementById('checkbox-charges-report');
            const checkboxRevenus = document.getElementById('checkbox-revenus-report');
            const checkboxAssociates = document.getElementById('checkbox-associates-report'); // Get the associates checkbox
            const checkboxProjets = document.getElementById('checkbox-projets-report'); // Get the new projets checkbox
            const checkboxRcpMeetings = document.getElementById('checkbox-rcp-meetings-report'); // Get the new RCP meetings checkbox

            // Check if all necessary elements exist before adding listeners
            if (btnDownloadReports && checkboxCharges && checkboxRevenus && checkboxAssociates && checkboxProjets && checkboxRcpMeetings) { // Include the new checkbox
                console.log("Report selection frame elements found, attaching download listener.");
                btnDownloadReports.addEventListener('click', function() {
                    console.log("Download reports button clicked.");
                    const downloadCharges = checkboxCharges.checked;
                    const downloadRevenus = checkboxRevenus.checked;
                    const downloadAssociates = checkboxAssociates.checked;
                    const downloadProjets = checkboxProjets.checked; // Check the new projets checkbox
                    const downloadRcpMeetings = checkboxRcpMeetings.checked; // Check the new RCP meetings checkbox

                    // Updated console log to include RCP meetings
                    console.log(`Charges selected: ${downloadCharges}, Revenues selected: ${downloadRevenus}, Associates selected: ${downloadAssociates}, Projets selected: ${downloadProjets}, RCP Meetings selected: ${downloadRcpMeetings}`);

                    if (downloadCharges) {
                        downloadReport('charges');
                    }
                    if (downloadRevenus) {
                        downloadReport('revenus');
                    }
                    if (downloadAssociates) {
                        downloadReport('associates');
                    }
                    if (downloadProjets) {
                        downloadReport('projets'); // Call downloadReport for projets
                    }
                    if (downloadRcpMeetings) { // Call downloadReport for RCP meetings if checked
                        downloadReport('rcp-meetings');
                    }
                });
            } else {
                // Log specific missing elements for easier debugging
                console.error("Report selection frame elements not found. Cannot attach download listener.", {
                    btnDownloadReports: !!btnDownloadReports,
                    checkboxCharges: !!checkboxCharges,
                    checkboxRevenus: !!checkboxRevenus,
                    checkboxAssociates: !!checkboxAssociates,
                    checkboxProjets: !!checkboxProjets,
                    checkboxRcpMeetings: !!checkboxRcpMeetings // Include the new checkbox in the log
                });
            }


            console.log("Initialization complete.");
        }

        // Appel de l'initialisation (assure que le DOM est prêt car c'est un module)
        initializePage();

        // --- Export Data Functionality ---
        let globalData = {}; // Variable to hold all data for export

        async function exportData() {
            const selectedData = {};
            const checkboxes = document.querySelectorAll('#exportDialog input[type="checkbox"]');

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const dataType = checkbox.id.replace('export-checkbox-', '');
                    if (globalData[dataType]) {
                        selectedData[dataType] = globalData[dataType];
                    }
                }
            });

            if (Object.keys(selectedData).length === 0) {
                alert("Veuillez sélectionner au moins un type de données à exporter.");
                return;
            }

            const dataStr = JSON.stringify(selectedData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `msp_gestion_export_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Close the modal after export
            document.getElementById('exportDialog').style.display = 'none';
        }

        // Event listeners for the export modal
        const exportDataBtn = document.getElementById('exportDataBtn');
        const exportDialog = document.getElementById('exportDialog');
        const confirmExportBtn = document.getElementById('confirmExportBtn');
        const cancelExportBtn = document.getElementById('cancelExportBtn');
        const modalCloseButtons = exportDialog ? exportDialog.querySelectorAll('.modal-close') : [];

        if (exportDataBtn && exportDialog && confirmExportBtn && cancelExportBtn) {
            exportDataBtn.addEventListener('click', () => {
                exportDialog.style.display = 'block';
            });

            confirmExportBtn.addEventListener('click', exportData);

            cancelExportBtn.addEventListener('click', () => {
                exportDialog.style.display = 'none';
            });

            modalCloseButtons.forEach(button => {
                button.addEventListener('click', () => {
                    exportDialog.style.display = 'none';
                });
            });

            window.addEventListener('click', (event) => {
                if (event.target === exportDialog) {
                    exportDialog.style.display = 'none';
                }
            });
        } else {
            console.error("Export modal elements not found. Cannot attach event listeners.", {
                exportDataBtn: !!exportDataBtn,
                exportDialog: !!exportDialog,
                confirmExportBtn: !!confirmExportBtn,
                cancelExportBtn: !!cancelExportBtn
            });
        }
        // --- End Export Data Functionality ---


        // Display username on load
        const usernameElement = document.getElementById('usernameDisplay');
        const token = localStorage.getItem('token');
        let username = 'developpement'; // Default value

        if (token) {
            try {
                // Decode JWT payload (second part)
                const payloadBase64 = token.split('.')[1];
                const payloadJson = atob(payloadBase64);
                const payload = JSON.parse(payloadJson);

                if (payload && payload.username) {
                    username = payload.username;
                }
            } catch (e) {
                console.error('Failed to decode JWT token:', e);
                // Keep default 'developpement' if decoding fails
            }
        }

        if (usernameElement) {
            usernameElement.textContent = username;
        } else {
            console.error("Username display element 'usernameDisplay' not found.");
        }
    </script>
    <script src="../js/ui/updateHeader.js"></script> <!-- Add header update script -->

    <!-- Modal for Report Export removed -->

    <!-- Modal for Export Data -->
    <div class="modal" id="exportDialog">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Exporter les données</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>Sélectionnez les données à exporter (format JSON) :</p>
                <div>
                    <input type="checkbox" id="export-checkbox-revenus" checked>
                    <label for="export-checkbox-revenus">Revenus ACI</label>
                </div>
                <div>
                    <input type="checkbox" id="export-checkbox-charges" checked>
                    <label for="export-checkbox-charges">Charges</label>
                </div>
                <div>
                    <input type="checkbox" id="export-checkbox-associes" checked>
                    <label for="export-checkbox-associes">Associés</label>
                </div>
                <div>
                    <input type="checkbox" id="export-checkbox-rcpmeetings" checked>
                    <label for="export-checkbox-rcpmeetings">Réunions RCP</label>
                </div>
                <div>
                    <input type="checkbox" id="export-checkbox-projets" checked>
                    <label for="export-checkbox-projets">Projets & Missions</label>
                </div>
                <div>
                    <input type="checkbox" id="export-checkbox-parametres" checked>
                    <label for="export-checkbox-parametres">Paramètres de répartition</label>
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirmExportBtn" class="btn btn-primary">Exporter</button>
                <button id="cancelExportBtn" class="btn btn-secondary modal-close">Annuler</button>
            </div>
        </div>
    </div>

</body>
</html>
