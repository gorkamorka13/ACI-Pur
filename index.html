<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSP Gestion - Maison de Santé Pluriprofessionnelle</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="stylesheet" href="css/style.css">
    <!-- Ajout de Font Awesome pour les icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo" style="background-color: #2c3e50;">
                <img src="/assets/favicon.ico" alt="Logo MSP" style="height: 20px; margin-right: 10px;"><h1>MSP Gestion</h1>
            </div>
            <nav>
                <ul>
                    <li class="active"><a href="index.html"><i class="fas fa-home"></i> Accueil</a></li>
                    <li><a href="templates/revenus.html"><i class="fas fa-money-bill-wave"></i> Revenus ACI</a></li>
                    <li><a href="templates/associes.html"><i class="fas fa-user-md"></i> Associés</a></li>
                    <li><a href="templates/charges.html"><i class="fas fa-file-invoice-dollar"></i> Charges</a></li>
                    <li><a href="templates/rcpmeeting.html"><i class="fas fa-users"></i> Réunions RCP</a></li>
                    <li><a href="templates/projets.html"><i class="fas fa-tasks"></i> Projets & Missions</a></li>
                    <li><a href="templates/repartition.html"><i class="fas fa-chart-pie"></i> Répartition</a></li>
                    <li><a href="templates/parametres.html"><i class="fas fa-cog"></i> Paramètres</a></li>
                    <li><a href="#" id="logoutButton"><i class="fas fa-sign-out-alt"></i> Déconnexion</a></li> <!-- Logout button -->
                </ul>
            </nav>
        </div>
        <div class="main-content">
            <header>
                <div class="header-content">
                    <h1>Tableau de bord</h1>
                    <div class="user-info">
                        <button id="exportDataBtn" style="margin-right: 15px;">Exporter les données</button> <!-- ID added, onclick removed -->
                        <span id="usernameDisplay">Administrateur</span> <!-- Added ID here -->
                        <i class="fas fa-user-circle"></i>
                    </div>
                </div>
            </header>
            <br>
            <div class="dashboard">
                <div class="welcome-section">
                    <h2>Bienvenue sur MSP Gestion</h2>
                    <p>Application de gestion pour votre Maison de Santé Pluriprofessionnelle</p>
                </div>
                <div class="quick-stats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Revenus ACI</h3>
                            <p class="total-amount" id="total-revenus">0 €</p>
                            <p class="year-label">Année <span id="annee-revenus">2023</span></p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-user-md"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Associés</h3>
                            <p class="total-amount" id="total-associes">0</p>
                            <p class="year-label">Professionnels actifs</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Charges</h3>
                            <p class="total-amount" id="total-charges">0 €</p>
                            <p class="year-label">Année <span id="annee-charges">2023</span></p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Réunions RCP</h3>
                            <p class="total-amount" id="total-reunions">0</p>
                            <p class="year-label">Année <span id="annee-reunions">2023</span></p>
                        </div>
                    </div>
                </div>

                <div class="dashboard-content">
                    <div class="chart-container">
                        <h3>Répartition des revenus</h3>
                        <div style="position: relative; height:300px; width:100%">
                            <canvas class="chart" id="repartition-chart"></canvas>
                        </div>
                    </div>
                    <div class="recent-activities parametres-section">
                        <h3>Paramètres de répartition actuels</h3>
                        <div class="parametres-content">
                            <div class="parametres-grid">
                                <div class="parametre-card">
                                    <div class="parametre-title">Part fixe</div>
                                    <div class="parametre-subtitle">Du revenu net</div>
                                    <div class="parametre-value" id="param-part-fixe">50%</div>
                                </div>
                                <div class="parametre-card">
                                    <div class="parametre-title">Facteur cogérant</div>
                                    <div class="parametre-subtitle">Associés gérants</div>
                                    <div class="parametre-value" id="param-facteur-cogerant">×1.7</div>
                                </div>
                                <div class="parametre-card">
                                    <div class="parametre-title">Part RCP</div>
                                    <div class="parametre-subtitle">Du revenu net</div>
                                    <div class="parametre-value" id="param-part-rcp">25%</div>
                                </div>
                                <div class="parametre-card">
                                    <div class="parametre-title">Part Projets</div>
                                    <div class="parametre-subtitle">Du revenu net</div>
                                    <div class="parametre-value" id="param-part-projets">25%</div>
                                </div>
                            </div>
                            <div class="parametres-chart-container">
                                <canvas id="parametres-pie-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Authentication -->
    <script type="module" src="js/auth.js"></script>

    <!-- Configuration -->
    <script type="module" src="js/config/config.js"></script>
    
    <!-- Utilitaires -->
    <script type="module" src="js/utils/dateUtils.js"></script>
    <script type="module" src="js/utils/validationUtils.js"></script>
    
    <!-- Services -->
    <script type="module" src="js/services/DataService.js"></script>
    <script type="module" src="js/services/AssocieService.js"></script>
    
    <!-- Migration - Désactivé -->
    <!-- <script type="module" src="js/migration/migrationService.js"></script> -->
    <!-- <script type="module" src="js/migration/index.js"></script> -->
    
    <!-- Application -->
    <script type="module" src="js/main.js"></script>
    <script type="module">
        import { dataService } from './js/services/DataService.js';

        let globalData = null;
        let repartitionChart = null; // Keep a reference to the repartition chart
        let parametresPieChart = null; // Keep a reference to the parameters pie chart

        // Fonction pour mettre à jour les statistiques et les graphiques
        async function updateStatsAndCharts() {
            try {
                const currentYear = new Date().getFullYear();

                // Mise à jour des années affichées (vérifier si les éléments existent)
                const elAnneeRevenus = document.getElementById('annee-revenus');
                if (elAnneeRevenus) elAnneeRevenus.textContent = currentYear;

                const elAnneeCharges = document.getElementById('annee-charges');
                if (elAnneeCharges) elAnneeCharges.textContent = currentYear;

                const elAnneeReunions = document.getElementById('annee-reunions');
                if (elAnneeReunions) elAnneeReunions.textContent = currentYear;

                // Chargement de toutes les données nécessaires, y compris RCP presence et Projets
                const [allData, rcpPresenceData] = await Promise.all([
                    dataService.loadAllData(),
                    dataService.loadRcpPresenceData()
                ]);

                if (!allData) throw new Error("Chargement des données principales a échoué.");

                // Combine all data into globalData
                globalData = {
                    ...allData,
                    rcpPresenceData: rcpPresenceData // Store RCP presence data
                };

                // Vérifier si les données essentielles sont chargées
                if (!globalData || !globalData.revenus || !globalData.charges || !globalData.rcpMeetings || !globalData.professionnels || !globalData.parametresRepartition || !globalData.projets || !globalData.rcpPresenceData) {
                    console.error('Données incomplètes après chargement:', globalData);
                    throw new Error('Données essentielles manquantes après le chargement.');
                }

                // Calcul des totaux pour l'année en cours
                const totalRevenus = globalData.revenus
                    .filter(rev => rev && rev.date && new Date(rev.date).getFullYear() === currentYear)
                    .reduce((sum, rev) => sum + parseFloat(rev.montant || 0), 0);

                const totalCharges = globalData.charges
                    .filter(chg => chg && chg.date && new Date(chg.date).getFullYear() === currentYear)
                    .reduce((sum, chg) => sum + parseFloat(chg.montant || 0), 0);

                const totalReunions = globalData.rcpMeetings
                    .filter(reu => reu && reu.date && new Date(reu.date).getFullYear() === currentYear)
                    .length;

                // Correction : Utiliser les noms de champs retournés par Sequelize (minuscules)
                const totalAssocies = globalData.professionnels
                    .filter(pro => pro && (pro.statut === 'Associé' || pro.statut === 'Cogérant'))
                    .length;

                // Mise à jour de l'affichage (vérifier si les éléments existent)
                const elTotalRevenus = document.getElementById('total-revenus');
                if (elTotalRevenus) elTotalRevenus.textContent = dataService.formatMontant(totalRevenus);

                const elTotalCharges = document.getElementById('total-charges');
                if (elTotalCharges) elTotalCharges.textContent = dataService.formatMontant(totalCharges);

                const elTotalReunions = document.getElementById('total-reunions');
                if (elTotalReunions) elTotalReunions.textContent = totalReunions;

                const elTotalAssocies = document.getElementById('total-associes');
                if (elTotalAssocies) elTotalAssocies.textContent = totalAssocies;

                // Mise à jour des paramètres (vérifier si les éléments existent)
                const params = globalData.parametresRepartition;
                if (params) {
                    const elPartFixe = document.getElementById('param-part-fixe');
                    if (elPartFixe) elPartFixe.textContent = (params.partFixe || 0) + '%';

                    const elFacteurCogerant = document.getElementById('param-facteur-cogerant');
                    if (elFacteurCogerant) elFacteurCogerant.textContent = '×' + (params.facteurCogerant || 0);

                    const elPartRCP = document.getElementById('param-part-rcp');
                    if (elPartRCP) elPartRCP.textContent = (params.partRCP || 0) + '%';

                    const elPartProjets = document.getElementById('param-part-projets');
                    if (elPartProjets) elPartProjets.textContent = (params.partProjets || 0) + '%';
                }

                // Mise à jour du graphique de répartition
                updateRepartitionChart();

                // Mise à jour du graphique des paramètres
                updateParametresPieChart();

            } catch (error) {
                console.error('Erreur lors de la mise à jour des statistiques et des graphiques:', error);
                // Afficher un message d'erreur plus ciblé si possible
                // alert('Une erreur est survenue lors du chargement des données. Veuillez réessayer plus tard.');
                const repartitionChartElement = document.getElementById('repartition-chart');
                 if (repartitionChartElement) {
                     const ctx = repartitionChartElement.getContext('2d');
                     ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                     ctx.textAlign = 'center';
                     ctx.fillStyle = 'red';
                     ctx.fillText("Erreur chargement données.", ctx.canvas.width/2, ctx.canvas.height/2);
                 }
                 const parametresChartElement = document.getElementById('parametres-pie-chart');
                 if (parametresChartElement) {
                     const ctx = parametresChartElement.getContext('2d');
                     ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                     ctx.textAlign = 'center';
                     ctx.fillStyle = 'red';
                     ctx.fillText("Erreur chargement données.", ctx.canvas.width/2, ctx.canvas.height/2);
                 }
            }
        }

        // Fonction pour afficher le graphique de répartition (aligné avec repartition.html)
        function updateRepartitionChart() {
            // Vérifier si les données nécessaires sont chargées
            if (!globalData || !globalData.professionnels || !globalData.parametresRepartition || !globalData.revenus || !globalData.charges || !globalData.rcpPresenceData || !globalData.projets) {
                 console.warn('Données manquantes pour le graphique de répartition (index.html), annulation de la mise à jour.');
                 return;
            }

            const chartElement = document.getElementById('repartition-chart');
            if (!chartElement) {
                console.error("Élément canvas 'repartition-chart' non trouvé.");
                return;
            }
            const ctx = chartElement.getContext('2d');

            const professionnels = globalData.professionnels;
            const params = globalData.parametresRepartition;
            const revenus = globalData.revenus;
            const charges = globalData.charges;
            const rcpPresenceData = globalData.rcpPresenceData;
            const projets = globalData.projets;

            // Calcul des montants
            const totalRevenus = revenus.reduce((sum, rev) => sum + parseFloat(rev.montant || 0), 0);
            const totalCharges = charges.reduce((sum, chg) => sum + parseFloat(chg.montant || 0), 0);
            const montantNet = Math.max(0, totalRevenus - totalCharges);

            const montantPartFixe = montantNet * ((params.partFixe || 0) / 100);
            const montantPartRCP = montantNet * ((params.partRCP || 0) / 100);
            const montantPartProjets = montantNet * ((params.partProjets || 0) / 100);

            // Filtrer uniquement les associés actifs pour la répartition
            const associesActifs = professionnels.filter(pro => pro && (pro.statut === 'Associé' || pro.statut === 'Cogérant'));
            const nbAssociesActifs = associesActifs.length || 1; // Eviter division par zéro

            // Calculer le total des points pondérés pour la part fixe
            const pointsFixePonderes = associesActifs.reduce((sum, p) => sum + ((p.statut === 'Cogérant' ? (params.facteurCogerant || 1) : 1) || 1), 0) || 1;

            // Calculate RCP points based on actual presence data
            const totalPresenceMinutes = rcpPresenceData.reduce((sum, item) => sum + (item.totalPresenceMinutes || 0), 0) || 1; // Avoid division by zero

            const presenceMap = new Map(rcpPresenceData.map(item => [item.id, item.totalPresenceMinutes || 0]));

            // --- Calculate Project Implication Scores ---
            const implicationScores = new Map(); // { associeId: score }
            associesActifs.forEach(p => implicationScores.set(p.id, 0)); // Initialize scores

            const responsableWeight = 2;
            const contributeurWeight = 1;
            let totalImplicationPoints = 0;

            projets.forEach(projet => {
                const poids = projet.poids || 0;

                // Process Responsables
                if (Array.isArray(projet.Responsables)) {
                    projet.Responsables.forEach(resp => {
                        // Ensure resp is a valid professional object and is an active associate
                        const associe = associesActifs.find(a => a.id === resp.id);
                        if (associe) {
                            const scoreToAdd = poids * responsableWeight;
                            implicationScores.set(associe.id, (implicationScores.get(associe.id) || 0) + scoreToAdd);
                            totalImplicationPoints += scoreToAdd;
                        }
                    });
                }

                // Process Contributeurs
                if (Array.isArray(projet.Contributeurs)) {
                    projet.Contributeurs.forEach(contrib => {
                        // Ensure contrib is a valid professional object and is an active associate
                        const associe = associesActifs.find(a => a.id === contrib.id);
                        if (associe) {
                            // Avoid double-counting if someone is both Responsable and Contributeur for the same project
                            const isAlsoResponsable = projet.Responsables?.some(r => r.id === associe.id);
                            if (!isAlsoResponsable) {
                                const scoreToAdd = poids * contributeurWeight;
                                implicationScores.set(associe.id, (implicationScores.get(associe.id) || 0) + scoreToAdd);
                                totalImplicationPoints += scoreToAdd;
                            }
                        }
                    });
                }
            });
             totalImplicationPoints = totalImplicationPoints || 1; // Avoid division by zero
            // --- End Project Implication Calculation ---


            // Préparation des données pour le graphique
            const data = {
                labels: associesActifs.map(pro => pro.nom),
                    datasets: [
                        {
                            label: `Part Fixe (${params.partFixe || 0}%)`,
                        data: associesActifs.map(pro =>
                            (montantPartFixe / pointsFixePonderes) * ((pro.statut === 'Cogérant' ? (params.facteurCogerant || 1) : 1) || 1)
                        ),
                            backgroundColor: '#2196F3',
                        stack: 'Stack 0',
                        },
                        {
                            label: `Part RCP (${params.partRCP || 0}%)`,
                            // Distribute montantPartRCP based on presence minutes
                            data: associesActifs.map(p => {
                                const presenceMinutes = presenceMap.get(p.id) || 0;
                                return (montantPartRCP * (presenceMinutes / totalPresenceMinutes));
                            }),
                            backgroundColor: '#4CAF50',
                            stack: 'Stack 0',
                        },
                        {
                            label: `Part Projets (${params.partProjets || 0}%)`,
                         // Distribute montantPartProjets based on calculated implication scores
                        data: associesActifs.map(p => {
                                const individualScore = implicationScores.get(p.id) || 0;
                                return (montantPartProjets * (individualScore / totalImplicationPoints));
                            }),
                            backgroundColor: '#FFC107',
                            stack: 'Stack 0',
                        }
                    ]
            };

            // Détruire l'ancien graphique s'il existe
            if (repartitionChart instanceof Chart) {
                repartitionChart.destroy();
            }

            try {
                 repartitionChart = new Chart(ctx, {
                     type: 'bar',
                     data: data, // Utiliser les données préparées
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                         plugins: {
                             title: { display: true, text: 'Répartition estimée des rémunérations' }, // Titre ajouté
                             legend: {
                                 position: 'top'
                             },
                             tooltip: {
                                 callbacks: {
                                     label: function(context) {
                                         return context.dataset.label + ': ' + dataService.formatMontant(context.raw);
                                     }
                                 }
                             }
                         },
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return dataService.formatMontant(value);
                                }
                            }
                        }
                    }
                }
            });
            } catch (chartError) {
                 console.error("Erreur lors de la création du graphique Chart.js (index.html):", chartError);
                 // Afficher une erreur dans le canvas si la création échoue
                 ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                 ctx.textAlign = 'center';
                 ctx.fillStyle = 'red';
                 ctx.fillText("Erreur chargement données.", ctx.canvas.width/2, ctx.canvas.height/2);
            }
        }

        // Fonction pour afficher le graphique des paramètres de répartition
        function updateParametresPieChart() {
            // Vérifier si les paramètres sont chargés
            if (!globalData || !globalData.parametresRepartition) {
                console.warn('Paramètres de répartition manquants pour le graphique (index.html), annulation de la mise à jour.');
                return;
            }

            const chartElement = document.getElementById('parametres-pie-chart');
            if (!chartElement) {
                console.error("Élément canvas 'parametres-pie-chart' non trouvé.");
                return;
            }
            const ctx = chartElement.getContext('2d');

            const params = globalData.parametresRepartition;

            // Préparation des données pour le graphique
            const data = {
                labels: ['Part Fixe', 'Part RCP', 'Part Projets'],
                datasets: [{
                    data: [params.partFixe || 0, params.partRCP || 0, params.partProjets || 0],
                    backgroundColor: ['#2196F3', '#4CAF50', '#FFC107'], // Matching colors with the bar chart
                    borderWidth: 1
                }]
            };

            // Détruire l'ancien graphique s'il existe
            if (parametresPieChart instanceof Chart) {
                parametresPieChart.destroy();
            }

            try {
                 parametresPieChart = new Chart(ctx, {
                     type: 'pie',
                     data: data,
                     options: {
                         responsive: true,
                         maintainAspectRatio: false,
                         plugins: {
                             legend: {
                                 position: 'top',
                             },
                             tooltip: {
                                 callbacks: {
                                     label: function(context) {
                                         const label = context.label || '';
                                         const value = context.raw || 0;
                                         return `${label}: ${value}%`;
                                     }
                                 }
                             }
                         }
                     }
                 });
            } catch (chartError) {
                 console.error("Erreur lors de la création du graphique Chart.js (parametres-pie-chart):", chartError);
                 ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                 ctx.textAlign = 'center';
                 ctx.fillText("Erreur graphique", ctx.canvas.width/2, ctx.canvas.height/2);
            }
        }


        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Display username on load
            const usernameElement = document.getElementById('usernameDisplay');
            const token = localStorage.getItem('token');
            let username = 'developpement'; // Default value

            if (token) {
                try {
                    // Decode JWT payload (second part)
                    const payloadBase64 = token.split('.')[1];
                    const payloadJson = atob(payloadBase64);
                    const payload = JSON.parse(payloadJson);

                    if (payload && payload.username) {
                        username = payload.username;
                    }
                } catch (e) {
                    console.error('Failed to decode JWT token:', e);
                    // Keep default 'developpement' if decoding fails
                }
            }

            if (usernameElement) {
                usernameElement.textContent = username;
            } else {
                console.error("Username display element 'usernameDisplay' not found.");
            }


            updateStatsAndCharts(); // Call the combined function

            // Attach export button listener
            const exportBtn = document.getElementById('exportDataBtn');
            const exportDialog = document.getElementById('exportDialog');
            const confirmExportBtn = document.getElementById('confirmExportBtn');
            const cancelExportBtn = document.getElementById('cancelExportBtn');
            const exportRevenusCheckbox = document.getElementById('exportRevenus');
            const exportChargesCheckbox = document.getElementById('exportCharges');
            const exportAssociesCheckbox = document.getElementById('exportAssocies');  
            const exportProjetsCheckbox = document.getElementById('exportProjets'); // Added checkbox for projects
            const exportRCPCheckbox = document.getElementById('exportRCP'); // Added checkbox for RCP          

            // Show the modal when the export button is clicked
            // Show the modal when the export button is clicked
            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    const exportDialog = document.getElementById('exportDialog'); // Re-get dialog inside listener
                    if (exportDialog) {
                        exportDialog.style.display = 'flex'; // Use flex to center the modal
                    } else {
                        console.error("Élément de dialogue 'exportDialog' non trouvé.");
                    }
                });
            } else {
                console.error("Bouton d'exportation 'exportDataBtn' non trouvé.");
            }

            // Hide the modal when the cancel button is clicked
            if (cancelExportBtn) {
                cancelExportBtn.addEventListener('click', () => {
                    exportDialog.style.display = 'none';
                });
            } else {
                console.error("Bouton d'annulation 'cancelExportBtn' non trouvé.");
            }

            // Handle export when the confirm button is clicked
            if (confirmExportBtn) {
                confirmExportBtn.addEventListener('click', () => {
                    const includeRevenus = exportRevenusCheckbox.checked;
                    const includeCharges = exportChargesCheckbox.checked;
                    const includeAssocies = exportAssociesCheckbox.checked; // Get the value of the checkbox
                    const includeProjets = exportProjetsCheckbox.checked; // Get the value of the checkbox for projects
                    const includeRCP = exportRCPCheckbox.checked; // Get the value of the checkbox for RCP
                    exportDialog.style.display = 'none'; // Hide the modal
                    exportData(includeRevenus, includeCharges, includeAssocies, includeProjets, includeRCP); // Call export function with options
                });
            } else {
                console.error("Bouton de confirmation 'confirmExportBtn' non trouvé.");
            }

            // Hide the modal if the user clicks outside of it
            window.addEventListener('click', (event) => {
                if (event.target === exportDialog) {
                    exportDialog.style.display = 'none';
                }
            });


            // Rafraîchissement périodique
            setInterval(updateStatsAndCharts, 30000); // Update stats and charts periodically
        });

        // Fonction d'export (modifiée pour accepter les options)
        function exportData(includeRevenus, includeCharges, includeAssocies, includeProjets, includeRCP) {
            if (!globalData) {
                console.warn("Aucune donnée globale disponible pour l'exportation.");
                return;
            }

            const dataToExport = {};

            if (includeRevenus && globalData.revenus) {
                dataToExport.revenus = globalData.revenus;
            }
            if (includeCharges && globalData.charges) {
                dataToExport.charges = globalData.charges;
            }
            if (includeAssocies && globalData.professionnels) {
                dataToExport.associes = globalData.professionnels.filter(pro => pro && (pro.statut === 'Associé' || pro.statut === 'Cogérant'));
            }
            if (includeRCP && globalData.rcpMeetings) {
                dataToExport.rcpMeetings = globalData.rcpMeetings;
            }
            if (includeProjets && globalData.projets) {
                dataToExport.projets = globalData.projets;
            }   

            // If no data is selected, maybe show a message or export an empty object
            if (Object.keys(dataToExport).length === 0) {
                 console.warn("Aucune donnée sélectionnée pour l'exportation.");
                 alert("Veuillez sélectionner au moins un type de données à exporter."); // Added alert
                 return; // Do not proceed with export if nothing is selected
            }


            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'export_data.json'; // Changed filename for clarity
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    </script>

    <!-- Export Dialog Box HTML -->
    <div id="exportDialog" class="modal">
        <div class="modal-content">
            <h2>Choisir les données à exporter</h2>
            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="exportRevenus" checked> Revenus ACI
                </label>
                <label>
                    <input type="checkbox" id="exportCharges" checked> Charges
                </label>
                <label>
                    <input type="checkbox" id="exportAssocies" checked> Associés
                </label>          
                <label>
                    <input type="checkbox" id="exportRCP" checked> RCP
                </label>
                <label>
                    <input type="checkbox" id="exportProjets" checked> Projets
            </div>
            <div class="modal-actions">
                <button id="confirmExportBtn">Exporter</button>
                <button id="cancelExportBtn">Annuler</button>
            </div>
        </div>
    </div>

    <style>
        /* Basic Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto; /* Center the modal */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be responsive */
            max-width: 400px; /* Max width */
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            text-align: center;
        }

        .modal-content h2 {
            margin-top: 0;
            color: #333;
        }

        .checkbox-group {
            margin: 20px 0;
            text-align: left;
        }

        .checkbox-group label {
            display: block;
            margin-bottom: 10px;
            font-size: 1em;
            color: #555;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
        }

        .modal-actions {
            display: flex;
            justify-content: space-around;
            gap: 10px; /* Space between buttons */
        }

        .modal-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }

        #confirmExportBtn {
            background-color: #4CAF50; /* Green */
            color: white;
        }

        #confirmExportBtn:hover {
            background-color: #45a049;
        }

        #cancelExportBtn {
            background-color: #f44336; /* Red */
            color: white;
        }

        #cancelExportBtn:hover {
            background-color: #da190b;
        }
    </style>
</body>
</html>
